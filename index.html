<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Espace discipline - hybrilink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- PWA Meta Tags -->
    <meta name="application-name" content="TheoV√™t">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TheoV√™t">
    <meta name="description" content="Solution compl√®te de gestion de commerce de v√™tements">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3498db">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3498db">


  <meta name="version" content="2.1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">


<!-- iOS specific tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CS La Colombe">
<link rel="apple-touch-icon" href="/icon-192x192.png">
<link rel="apple-touch-icon" sizes="152x152" href="/icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icon-192x192.png">
<link rel="apple-touch-icon" sizes="167x167" href="/icon-192x192.png">

<!-- Splash Screen pour iOS -->
<link rel="apple-touch-startup-image" 
      href="/splashscreens/iphone5_splash.png"
      media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
<link rel="apple-touch-startup-image" 
      href="/splashscreens/iphone6_splash.png"
      media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
<link rel="apple-touch-startup-image" 
      href="/splashscreens/iphoneplus_splash.png"
      media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
<link rel="apple-touch-startup-image" 
      href="/splashscreens/iphonex_splash.png"
      media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
<link rel="apple-touch-startup-image" 
      href="/splashscreens/ipad_splash.png"
      media="(min-device-width: 768px) and (max-device-width: 1024px) and (-webkit-min-device-pixel-ratio: 2) and (orientation: portrait)">

    <!-- Service Worker et mise √† jour -->
    

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon-167x167.png">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Styles et Biblioth√®ques -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Scripts de mise √† jour -->
    <script src="update-system.js"></script>

<!-- Script d'installation PWA obligatoire -->
<script src="install-prompt.js"></script>
    <style>
        :root {
            --primary: #3498db; 
            --secondary: #2c3e50; 
            --success: #27ae60;
            --danger: #e74c3c; 
            --warning: #f39c12; 
            --info: #1abc9c;
            --light: #ecf0f1; 
            --dark: #34495e;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
            --radius: 8px;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f5f6fa;
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* --- Styles Communs --- */
        .login-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            padding: 1rem;
        }
        
        .login-card { 
            background: white; 
            padding: 2rem; 
            border-radius: var(--radius); 
            width: 100%; 
            max-width: 400px; 
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .app-container { 
            display: flex; 
            min-height: 100vh; 
            flex-direction: column;
        }
        
        .sidebar { 
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px; 
            height: 100vh;
            background: white; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.08); 
            z-index: 1001;
            transition: left 0.3s ease;
            overflow-y: auto;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .nav-menu { 
            list-style: none; 
            padding: 1rem 0; 
            margin: 0; 
        }
        
        .nav-menu li a { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 14px 20px; 
            color: var(--dark); 
            text-decoration: none; 
            font-weight: 500; 
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        
        .nav-menu li a.active, 
        .nav-menu li a:hover { 
            background: #eaf5fc; 
            color: var(--primary); 
            border-left-color: var(--primary);
        }
        /* Styles sp√©cifiques pour les prompts d'installation */
.platform-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #3498db;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 11px;
    z-index: 1000000;
    display: none; /* Afficher pour le d√©bogage seulement */
}

/* Badge flottant pour iOS */
.ios-float-badge {
    position: fixed;
    bottom: 100px;
    right: 20px;
    background: linear-gradient(135deg, #007AFF, #5856D6);
    color: white;
    border-radius: 50px;
    padding: 12px 20px;
    box-shadow: 0 10px 30px rgba(0, 122, 255, 0.3);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 99999;
    animation: float 3s infinite ease-in-out;
    cursor: pointer;
}

.ios-float-badge i {
    font-size: 18px;
}

.ios-float-badge span {
    font-weight: 600;
    font-size: 14px;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* Instructions iOS */
.ios-steps {
    counter-reset: step-counter;
}

.ios-step {
    position: relative;
    padding-left: 50px;
    margin-bottom: 20px;
}

.ios-step::before {
    counter-increment: step-counter;
    content: counter(step-counter);
    position: absolute;
    left: 0;
    top: 0;
    width: 40px;
    height: 40px;
    background: #007AFF;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}
        
        .main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            width: 100%;
        }
        
        .app-header { 
            background: white; 
            padding: 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .content-area { 
            padding: 1rem; 
            flex: 1;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Styles pour les notifications de mise √† jour */
        .update-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid #3498db;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 15px 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .update-toast.show {
            transform: translateX(0);
        }

        .update-toast.success {
            border-left-color: #27ae60;
        }

        .update-toast.warning {
            border-left-color: #f39c12;
        }

        .update-toast.danger {
            border-left-color: #e74c3c;
        }

        /* Badges d'application */
        .app-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 99999;
            animation: pulse 1.5s infinite;
        }

        /* Animation pour badges */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Badge dans le header */
        #notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        
        .page { 
            display: none; 
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .page.active { 
            display: block; 
        }
        
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: 500; 
            color: white; 
            font-size: 0.95rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); }
        .btn-danger { background: var(--danger); }
        .btn-info { background: var(--info); }
        .btn-secondary { background: var(--secondary); }
        
        .form-control { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-sizing: border-box; 
            font-size: 0.95rem;
        }
        
        .form-group { 
            margin-bottom: 1rem; 
            width: 100%;
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500;
        }
        
        /* --- Styles pour les photos de profil --- */
        .discipline-photo-header {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }
        
        .photo-placeholder-header {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        /* --- Styles pour le menu --- */
        .menu-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark);
            cursor: pointer;
            display: block;
            padding: 0.5rem;
        }
        
        .submenu {
            list-style: none;
            padding-left: 2rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .submenu.active {
            max-height: 500px;
        }
        
        .submenu li a {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .has-submenu > a::after {
            content: '\f107';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-left: auto;
            transition: transform 0.3s ease;
        }
        
        .has-submenu.active > a::after {
            transform: rotate(180deg);
        }

        /* --- Styles pour le tableau de pr√©sence --- */
        .attendance-controls {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            width: 100%;
        }
        
        .attendance-table-container {
            overflow-x: auto;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .attendance-table th,
        .attendance-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .attendance-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .attendance-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .teacher-name {
            text-align: left;
            font-weight: 500;
            min-width: 150px;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }
        
        .day-cell {
            cursor: pointer;
            min-width: 40px;
            height: 40px;
            transition: background-color 0.2s;
            font-size: 0.8rem;
        }
        
        .day-cell:hover {
            background-color: #f0f7ff;
        }
        
        .present { background-color: #e8f5e8; }
        .absent { background-color: #ffebee; }
        .late { background-color: #fff3e0; }
        
        .status-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .status-option {
            padding: 8px 16px;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }
        
        .status-option.active {
            border-color: var(--primary);
        }
        
        .status-present { background-color: #e8f5e8; color: #2e7d32; }
        .status-absent { background-color: #ffebee; color: #c62828; }
        .status-late { background-color: #fff3e0; color: #ef6c00; }
        
        .publish-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
        }

        .stat-card h3 {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .stat-card span {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark);
        }

        .list-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            background: white;
        }

        /* --- Styles pour les incidents --- */
        .incident-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .incident-tab {
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .incident-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .incident-content {
            display: none;
            width: 100%;
        }

        .incident-content.active {
            display: block;
        }

        .incident-behavior-form {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .behavior-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            background: white;
            border-radius: 5px;
        }

        .behavior-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .behavior-item button {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .incident-tracking {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #eee;
        }

        .incident-history {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .history-item {
            padding: 0.75rem;
            border-left: 4px solid var(--primary);
            background: #f8f9fa;
            margin-bottom: 0.5rem;
            border-radius: 0 5px 5px 0;
        }

        .progress-container {
            margin: 1.5rem 0;
        }
/* Styles pour le modal d'installation */
#install-prompt-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999999;
    animation: fadeIn 0.3s ease;
}

#install-prompt-modal .modal-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    text-align: center;
    animation: slideUp 0.3s ease;
}

#install-prompt-modal h2 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.5rem;
}

#install-prompt-modal p {
    color: #555;
    margin-bottom: 25px;
    line-height: 1.6;
}

#install-button {
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    width: 100%;
    margin-bottom: 10px;
}

#install-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
}

#later-button {
    background: transparent;
    color: #666;
    border: 1px solid #ddd;
    padding: 12px 30px;
    border-radius: 50px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
}

#later-button:hover {
    background: #f8f9fa;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Badge d'installation pour iOS */
.ios-install-badge {
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: white;
    border-radius: 50px;
    padding: 10px 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 99999;
    animation: bounce 2s infinite;
}

.ios-install-badge i {
    color: #007AFF;
    font-size: 20px;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}


        .progress-bar {
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--info), var(--warning), var(--danger));
            transition: width 0.3s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .student-info-card {
            background: #f0f7ff;
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* --- Overlay pour menu mobile --- */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* --- Media Queries pour Responsive --- */
        @media (min-width: 768px) {
            html {
                font-size: 16px;
            }
            
            .app-container {
                flex-direction: row;
            }
            
            .sidebar {
                position: relative;
                left: 0;
                width: 250px;
                height: 100vh;
                overflow-y: auto;
            }
            
            .main-content {
                width: calc(100% - 250px);
            }
            
            .menu-toggle {
                display: none;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
            
            .content-area {
                padding: 2rem;
            }
            
            .app-header {
                padding: 1rem 2rem;
            }
            
            .attendance-controls {
                padding: 1.5rem;
            }
            
            .behavior-item {
                flex-direction: row;
                align-items: center;
            }
            
            .behavior-item input {
                flex: 1;
            }
            
            .list-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .incident-tab {
                padding: 12px 24px;
            }
        }

        @media (max-width: 767px) {
            html {
                font-size: 14px;
            }
            
            .login-card {
                padding: 1.5rem;
                margin: 0 1rem;
            }
            
            .app-header {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .attendance-table th,
            .attendance-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            .day-cell {
                min-width: 35px;
                height: 35px;
            }
            
            .teacher-name {
                min-width: 120px;
            }
            
            .status-option {
                min-width: 100px;
                padding: 6px 12px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            .publish-actions {
                flex-direction: column;
            }
            
            .publish-actions .btn {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .progress-labels {
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .status-selector {
                flex-direction: column;
            }
            
            .status-option {
                width: 100%;
            }
            
            .incident-tabs {
                flex-direction: column;
                border-bottom: none;
            }
            
            .incident-tab {
                border-bottom: 1px solid #eee;
                text-align: left;
            }
            
            .app-header h2 {
                font-size: 1.2rem;
                order: 3;
                width: 100%;
                text-align: center;
                margin-top: 0.5rem;
            }
        }

        /* --- Am√©liorations pour tr√®s petits √©crans --- */
        @media (max-width: 320px) {
            .card {
                padding: 1rem;
            }
            
            .content-area {
                padding: 0.75rem;
            }
            
            .attendance-controls {
                padding: 1rem;
            }
            
            .form-control {
                padding: 8px;
            }
        }

        /* --- Styles pour am√©liorer la lisibilit√© --- */
        h1, h2, h3, h4, h5, h6 {
            color: var(--dark);
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        h2 {
            font-size: 1.5rem;
        }

        h3 {
            font-size: 1.25rem;
        }

        h4 {
            font-size: 1.1rem;
        }

        p {
            margin-bottom: 1rem;
            color: #555;
        }

        /* --- Am√©lioration du contraste et accessibilit√© --- */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* --- Styles pour les √©l√©ments de formulaire --- */
        select, 
        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea {
            font-size: 16px; /* Emp√™che le zoom automatique sur iOS */
        }

        @media (max-width: 767px) {
            select, 
            input[type="text"],
            input[type="email"],
            input[type="password"],
            textarea {
                font-size: 16px;
            }
        }

        /* --- Correction du d√©filement horizontal --- */
        body, .content-area, .page {
            overflow-x: hidden;
            max-width: 100vw;
        }
    </style>
</head>
<body>
    <!-- √âcran de connexion -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-card">
            <h3>Portail Discipline</h3>
            <form id="login-form" style="margin-top: 2rem;">
                <div class="form-group">
                    <input type="email" class="form-control" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" placeholder="Mot de passe" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Connexion</button>
            </form>
        </div>
    </div>

    <!-- Overlay pour fermer le menu mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Contenu de l'application -->
    <div id="app-root" class="app-container hidden">
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-gavel" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Discipline</h3>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i> Tableau de bord</a></li>
                <li class="has-submenu">
                    <a href="#"><i class="fas fa-user-check fa-fw"></i> Pr√©sence</a>
                    <ul class="submenu">
                        <li><a href="#" data-page="teacher-attendance">Pr√©sence Enseignants</a></li>
                        <li><a href="#" data-page="student-attendance">Pr√©sence √âl√®ves</a></li>
                    </ul>
                </li>
                <li><a href="#" data-page="student-incidents"><i class="fas fa-exclamation-triangle fa-fw"></i> Incidents √âl√®ves</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Tableau de bord</h2>
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div id="discipline-photo-header">
                        <!-- La photo sera charg√©e dynamiquement -->
                    </div>
                    <span id="discipline-user-name" style="font-weight: 500;"></span>
                    <button id="logout-btn" class="btn btn-danger">D√©connexion</button>
                </div>
            </header>
            <main class="content-area">
                <!-- Page: Tableau de bord -->
                <div id="dashboard-page" class="page active">
                    <div class="card">
                        <h3>Tableau de bord Discipline</h3>
                        <p>Bienvenue dans votre espace de gestion de la discipline. Vous pouvez g√©rer les pr√©sences des enseignants et des √©l√®ves, ainsi que les incidents.</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="card stat-card">
                            <h3>Enseignants</h3>
                            <span id="teachers-count">-</span>
                        </div>
                        <div class="card stat-card">
                            <h3>√âl√®ves</h3>
                            <span id="students-count">-</span>
                        </div>
                        <div class="card stat-card">
                            <h3>Incidents du jour</h3>
                            <span id="incidents-today">-</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Activit√©s r√©centes</h3>
                        <div id="recent-activities">
                            <p>Aucune activit√© r√©cente</p>
                        </div>
                    </div>
                </div>

                <!-- Page: Pr√©sence des Enseignants -->
                <div id="teacher-attendance-page" class="page">
                    <div class="attendance-controls">
                        <h3>Pointage des enseignants</h3>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label>Mois</label>
                                <select id="teacher-month" class="form-control">
                                    <option value="0">Janvier</option>
                                    <option value="1">F√©vrier</option>
                                    <option value="2">Mars</option>
                                    <option value="3">Avril</option>
                                    <option value="4">Mai</option>
                                    <option value="5">Juin</option>
                                    <option value="6">Juillet</option>
                                    <option value="7">Ao√ªt</option>
                                    <option value="8">Septembre</option>
                                    <option value="9">Octobre</option>
                                    <option value="10">Novembre</option>
                                    <option value="11">D√©cembre</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label>Ann√©e</label>
                                <select id="teacher-year" class="form-control">
                                    <!-- Les ann√©es seront charg√©es dynamiquement -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="status-selector">
                            <div class="status-option status-present active" data-status="present">
                                <span>‚úÖ</span> Pr√©sent
                            </div>
                            <div class="status-option status-absent" data-status="absent">
                                <span>üö´</span> Absent
                            </div>
                            <div class="status-option status-late" data-status="late">
                                <span>üü†</span> Retard
                            </div>
                        </div>
                        
                        <button id="show-teacher-attendance-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                            Afficher le tableau
                        </button>
                    </div>
                    
                    <div id="teacher-attendance-table-container" class="hidden">
                        <div class="attendance-table-container">
                            <table class="attendance-table" id="teacher-attendance-table">
                                <thead>
                                    <tr>
                                        <th>Nom complet</th>
                                        <!-- Les jours seront ajout√©s dynamiquement -->
                                    </tr>
                                </thead>
                                <tbody id="teacher-attendance-body">
                                    <!-- Les enseignants seront ajout√©s dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="publish-actions">
                            <button id="save-teacher-attendance-btn" class="btn btn-success">
                                Sauvegarder
                            </button>
                            <button id="publish-teacher-attendance-btn" class="btn btn-primary">
                                Publier aux enseignants
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Page: Pr√©sence des √âl√®ves -->
                <div id="student-attendance-page" class="page">
                    <div class="attendance-controls">
                        <h3>Pointage des √©l√®ves</h3>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label>Classe</label>
                                <select id="student-class" class="form-control">
                                    <option value="">-- S√©lectionner une classe --</option>
                                    <!-- Les classes seront charg√©es dynamiquement -->
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label>Mois</label>
                                <select id="student-month" class="form-control">
                                    <option value="0">Janvier</option>
                                    <option value="1">F√©vrier</option>
                                    <option value="2">Mars</option>
                                    <option value="3">Avril</option>
                                    <option value="4">Mai</option>
                                    <option value="5">Juin</option>
                                    <option value="6">Juillet</option>
                                    <option value="7">Ao√ªt</option>
                                    <option value="8">Septembre</option>
                                    <option value="9">Octobre</option>
                                    <option value="10">Novembre</option>
                                    <option value="11">D√©cembre</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label>Ann√©e</label>
                                <select id="student-year" class="form-control">
                                    <!-- Les ann√©es seront charg√©es dynamiquement -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="status-selector">
                            <div class="status-option status-present active" data-status="present">
                                <span>‚úÖ</span> Pr√©sent
                            </div>
                            <div class="status-option status-absent" data-status="absent">
                                <span>üö´</span> Absent
                            </div>
                            <div class="status-option status-late" data-status="late">
                                <span>üü†</span> Retard
                            </div>
                        </div>
                        
                        <button id="show-student-attendance-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                            Afficher le tableau
                        </button>
                    </div>
                    
                    <div id="student-attendance-table-container" class="hidden">
                        <div class="attendance-table-container">
                            <table class="attendance-table" id="student-attendance-table">
                                <thead>
                                    <tr>
                                        <th>Nom complet</th>
                                        <!-- Les jours seront ajout√©s dynamiquement -->
                                    </tr>
                                </thead>
                                <tbody id="student-attendance-body">
                                    <!-- Les √©l√®ves seront ajout√©s dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="publish-actions">
                            <button id="save-student-attendance-btn" class="btn btn-success">
                                Sauvegarder
                            </button>
                            <button id="publish-student-attendance-btn" class="btn btn-primary">
                                Publier aux parents
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Page: Incidents des √âl√®ves -->
                <div id="student-incidents-page" class="page">
                    <h3>Gestion des incidents √©l√®ves</h3>
                    
                    <!-- Onglets pour naviguer entre les diff√©rentes sections -->
                    <div class="incident-tabs">
                        <button class="incident-tab active" data-tab="behavior">D√©finir comportements</button>
                        <button class="incident-tab" data-tab="report">Signaler incident</button>
                        <button class="incident-tab" data-tab="tracking">Suivi incidents</button>
                    </div>
                    
                    <!-- Section 1: D√©finition des comportements/types d'incidents -->
                    <div id="behavior-tab" class="incident-content active">
                        <div class="card">
                            <h4>Types d'incidents et leurs comportements</h4>
                            <p>D√©finissez ici les diff√©rents types d'incidents et leurs caract√©ristiques.</p>
                            
                            <div id="behavior-list" class="incident-behavior-form">
                                <!-- Les types d'incidents seront charg√©s dynamiquement -->
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <div class="form-group">
                                    <label for="new-behavior-type">Nouveau type d'incident</label>
                                    <input type="text" id="new-behavior-type" class="form-control" placeholder="Ex: Bagarre, Vole, Tricherie, etc.">
                                </div>
                                <div class="form-group">
                                    <label for="new-behavior-description">Description du comportement</label>
                                    <textarea id="new-behavior-description" class="form-control" rows="2" placeholder="D√©crivez le comportement..."></textarea>
                                </div>
                                <button id="add-behavior-btn" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Ajouter ce type d'incident
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Signalement d'incident -->
                    <div id="report-tab" class="incident-content">
                        <div class="card">
                            <h4>Signaler un nouvel incident</h4>
                            
                            <div class="form-group">
                                <label for="student-matricule">Matricule de l'√©l√®ve</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="student-matricule" class="form-control" placeholder="Entrez le matricule exact" style="flex: 1;">
                                    <button id="validate-matricule-btn" class="btn btn-primary">
                                        Valider
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Informations de l'√©l√®ve (affich√©es apr√®s validation) -->
                            <div id="student-info-display" class="hidden">
                                <div class="student-info-card">
                                    <h5>Informations de l'√©l√®ve</h5>
                                    <p><strong>Nom:</strong> <span id="student-display-name"></span></p>
                                    <p><strong>Matricule:</strong> <span id="student-display-matricule"></span></p>
                                    <p><strong>Classe:</strong> <span id="student-display-class"></span></p>
                                </div>
                                
                                <div class="form-group">
                                    <label>Type d'incident</label>
                                    <select id="incident-type-select" class="form-control" required>
                                        <option value="">-- S√©lectionner un type d'incident --</option>
                                        <!-- Les types seront charg√©s dynamiquement -->
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Description d√©taill√©e</label>
                                    <textarea id="incident-description" class="form-control" rows="3" placeholder="D√©crivez l'incident en d√©tail..." required></textarea>
                                </div>
                                
                                <div class="action-buttons">
                                    <button id="report-incident-btn" class="btn btn-warning">
                                        <i class="fas fa-exclamation-triangle"></i> Signaler l'incident
                                    </button>
                                    <button id="reset-incident-form" class="btn btn-secondary">
                                        <i class="fas fa-redo"></i> R√©initialiser
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Suivi des incidents -->
                    <div id="tracking-tab" class="incident-content">
                        <div class="card">
                            <h4>Suivi des incidents par √©l√®ve</h4>
                            
                            <div class="form-group">
                                <label for="tracking-matricule">Matricule de l'√©l√®ve</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="tracking-matricule" class="form-control" placeholder="Entrez le matricule exact" style="flex: 1;">
                                    <button id="search-incidents-btn" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Rechercher
                                    </button>
                                </div>
                            </div>
                            
                            <!-- R√©sultats de recherche -->
                            <div id="tracking-results" class="hidden">
                                <!-- Informations de l'√©l√®ve -->
                                <div class="student-info-card">
                                    <h5>√âl√®ve: <span id="tracking-student-name"></span></h5>
                                    <p><strong>Matricule:</strong> <span id="tracking-student-matricule"></span></p>
                                    <p><strong>Classe:</strong> <span id="tracking-student-class"></span></p>
                                    <p><strong>Score de discipline:</strong> <span id="tracking-score">0%</span></p>
                                </div>
                                
                                <!-- Barre de progression -->
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                                    </div>
                                    <div class="progress-labels">
                                        <span>0% (Avertissement)</span>
                                        <span>50% (Suspension)</span>
                                        <span>100% (Renvoi d√©finitif)</span>
                                    </div>
                                </div>
                                
                                <!-- Filtre par type d'incident -->
                                <div class="form-group">
                                    <label>Filtrer par type d'incident</label>
                                    <select id="incident-type-filter" class="form-control">
                                        <option value="all">Tous les types</option>
                                        <!-- Les types seront charg√©s dynamiquement -->
                                    </select>
                                </div>
                                
                                <!-- Historique des incidents -->
                                <h5>Historique des incidents</h5>
                                <div id="incident-history" class="incident-history">
                                    <!-- L'historique sera charg√© dynamiquement -->
                                </div>
                                
                                <!-- Mise √† jour du score -->
                                <div class="incident-tracking">
                                    <h5>Mettre √† jour le score de discipline</h5>
                                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                        <input type="range" id="discipline-score-slider" min="0" max="100" value="0" style="flex: 1;">
                                        <span id="score-display" style="min-width: 50px;">0%</span>
                                    </div>
                                    <div class="form-group" style="margin-top: 1rem;">
                                        <label>Commentaire sur la mise √† jour</label>
                                        <textarea id="score-comment" class="form-control" rows="2" placeholder="Raison de la modification du score..."></textarea>
                                    </div>
                                    <div class="action-buttons">
                                        <button id="update-score-btn" class="btn btn-info">
                                            <i class="fas fa-save"></i> Mettre √† jour le score
                                        </button>
                                        <button id="reset-score-btn" class="btn btn-danger">
                                            <i class="fas fa-undo"></i> R√©initialiser le score
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
    // INITIALISATION DE FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, updateDoc, writeBatch, orderBy, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
        authDomain: "theo1d.firebaseapp.com",
        projectId: "theo1d",
        storageBucket: "theo1d.firebasestorage.app",
        messagingSenderId: "269629842962",
        appId: "1:269629842962:web:a80a12b04448fe1e595acb",
        measurementId: "G-TNSG1XFMDZ"
    };
        
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentDisciplineUser = null;
    let currentSelectedStatus = 'present';
    let teacherAttendanceData = {};
    let studentAttendanceData = {};
    let selectedStudentForIncident = null;
    let behaviorTypes = [];
    let currentTrackedStudent = null;

    // FONCTION POUR AFFICHER LA PHOTO DE PROFIL
    function displayDisciplinePhoto(photoURL) {
        const headerElement = document.getElementById('discipline-photo-header');
        if (!headerElement) return;
        
        if (photoURL) {
            headerElement.innerHTML = `<img src="${photoURL}" class="discipline-photo-header">`;
        } else {
            headerElement.innerHTML = '<div class="photo-placeholder-header"><i class="fas fa-user-tie"></i></div>';
        }
    }

    // AUTHENTIFICATION
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("Utilisateur connect√©:", user.uid);
            try {
                const q = query(collection(db, 'discipline'), where('uid', '==', user.uid));
                const snap = await getDocs(q);
                
                if (!snap.empty) {
                    currentDisciplineUser = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    console.log("Utilisateur discipline trouv√©:", currentDisciplineUser);
                    
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('app-root').classList.remove('hidden');
                    document.getElementById('discipline-user-name').textContent = currentDisciplineUser.fullName;
                    
                    displayDisciplinePhoto(currentDisciplineUser.photoURL);
                    initializePortal();
                } else {
                    console.log("Aucun utilisateur discipline trouv√©");
                    await signOut(auth);
                    alert("Acc√®s refus√©. Vous n'√™tes pas autoris√© √† acc√©der au portail discipline.");
                }
            } catch (error) {
                console.error("Erreur lors de la v√©rification de l'utilisateur:", error);
                await signOut(auth);
                alert("Erreur d'authentification.");
            }
        } else {
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('app-root').classList.add('hidden');
        }
    });

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = e.target.elements[0].value;
        const password = e.target.elements[1].value;
        
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error("Erreur de connexion:", error);
            alert("Email ou mot de passe incorrect.");
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    // INITIALISATION
    function initializePortal() {
        console.log("Initialisation du portail discipline");
        loadDashboardData();
        setupAttendanceControls();
        setupMenuToggle();
        setupSubmenuToggle();
        loadYearSelectors();
        loadBehaviorTypes();
        setupIncidentTabs();
    }

    // CONFIGURATION DU MENU MOBILE
    function setupMenuToggle() {
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        });
        
        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        });
        
        // Fermer le menu en cliquant sur un lien
        document.querySelectorAll('.nav-menu a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 767) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
            });
        });
    }

    // CONFIGURATION DES SOUS-MENUS
    function setupSubmenuToggle() {
        const submenuItems = document.querySelectorAll('.has-submenu > a');
        
        submenuItems.forEach(item => {
            item.addEventListener('click', (e) => {
                if (window.innerWidth <= 767) {
                    e.preventDefault();
                    const parent = item.parentElement;
                    const submenu = parent.querySelector('.submenu');
                    
                    document.querySelectorAll('.has-submenu').forEach(el => {
                        if (el !== parent) {
                            el.classList.remove('active');
                            el.querySelector('.submenu').classList.remove('active');
                        }
                    });
                    
                    parent.classList.toggle('active');
                    submenu.classList.toggle('active');
                }
            });
        });
    }

    // CHARGEMENT DES DONN√âES DU TABLEAU DE BORD
    async function loadDashboardData() {
        console.log("Chargement des donn√©es du tableau de bord");
        try {
            // Compter les enseignants
            const teachersSnap = await getDocs(collection(db, 'teachers'));
            document.getElementById('teachers-count').textContent = teachersSnap.size;
            console.log("Enseignants charg√©s:", teachersSnap.size);
            
            // Compter les √©l√®ves
            const studentsSnap = await getDocs(collection(db, 'students'));
            document.getElementById('students-count').textContent = studentsSnap.size;
            console.log("√âl√®ves charg√©s:", studentsSnap.size);
            
            // Compter les incidents du jour
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const incidentsQuery = query(
                collection(db, 'incidents'), 
                where('createdAt', '>=', today),
                where('createdAt', '<', tomorrow)
            );
            const incidentsSnap = await getDocs(incidentsQuery);
            document.getElementById('incidents-today').textContent = incidentsSnap.size;
            console.log("Incidents du jour:", incidentsSnap.size);
            
        } catch (error) {
            console.error('Erreur chargement tableau de bord:', error);
        }
    }

    // CONFIGURATION DES CONTR√îLES DE PR√âSENCE
    function setupAttendanceControls() {
        // Gestion du s√©lecteur de statut
        const statusOptions = document.querySelectorAll('.status-option');
        statusOptions.forEach(option => {
            option.addEventListener('click', () => {
                statusOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                currentSelectedStatus = option.dataset.status;
                console.log("Statut s√©lectionn√©:", currentSelectedStatus);
            });
        });
        
        // Boutons pour afficher les tableaux
        document.getElementById('show-teacher-attendance-btn').addEventListener('click', () => {
            const month = parseInt(document.getElementById('teacher-month').value);
            const year = parseInt(document.getElementById('teacher-year').value);
            console.log("Chargement tableau enseignants - Mois:", month, "Ann√©e:", year);
            loadTeacherAttendanceTable(month, year);
        });
        
        document.getElementById('show-student-attendance-btn').addEventListener('click', () => {
            const classId = document.getElementById('student-class').value;
            const month = parseInt(document.getElementById('student-month').value);
            const year = parseInt(document.getElementById('student-year').value);
            
            if (!classId) {
                alert('Veuillez s√©lectionner une classe');
                return;
            }
            
            console.log("Chargement tableau √©l√®ves - Classe:", classId, "Mois:", month, "Ann√©e:", year);
            loadStudentAttendanceTable(classId, month, year);
        });
        
        // Boutons de sauvegarde et publication
        document.getElementById('save-teacher-attendance-btn').addEventListener('click', saveTeacherAttendance);
        document.getElementById('publish-teacher-attendance-btn').addEventListener('click', publishTeacherAttendance);
        document.getElementById('save-student-attendance-btn').addEventListener('click', saveStudentAttendance);
        document.getElementById('publish-student-attendance-btn').addEventListener('click', publishStudentAttendance);
        
        // Charger les classes
        loadClassesForAttendance();
    }

    // CHARGEMENT DES S√âLECTEURS D'ANN√âE
    function loadYearSelectors() {
        const currentYear = new Date().getFullYear();
        const yearSelectors = document.querySelectorAll('#teacher-year, #student-year');
        
        yearSelectors.forEach(select => {
            select.innerHTML = '';
            for (let year = currentYear - 1; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                select.appendChild(option);
            }
        });
        
        const currentMonth = new Date().getMonth();
        document.getElementById('teacher-month').value = currentMonth;
        document.getElementById('student-month').value = currentMonth;
    }

    // CHARGEMENT DES CLASSES POUR LA PR√âSENCE DES √âL√àVES
    async function loadClassesForAttendance() {
        const classSelect = document.getElementById('student-class');
        
        try {
            const studentsSnap = await getDocs(collection(db, 'students'));
            const uniqueClasses = new Set();
            
            studentsSnap.forEach(doc => {
                const student = doc.data();
                if (student.class) {
                    uniqueClasses.add(student.class);
                }
            });
            
            classSelect.innerHTML = '<option value="">-- S√©lectionner une classe --</option>';
            
            uniqueClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelect.appendChild(option);
            });
            
            console.log("Classes charg√©es:", uniqueClasses.size);
        } catch (error) {
            console.error('Erreur chargement classes:', error);
        }
    }

    // CHARGEMENT DU TABLEAU DE PR√âSENCE DES ENSEIGNANTS
    async function loadTeacherAttendanceTable(month, year) {
        const container = document.getElementById('teacher-attendance-table-container');
        const tableBody = document.getElementById('teacher-attendance-body');
        
        container.classList.remove('hidden');
        tableBody.innerHTML = '<tr><td colspan="32">Chargement...</td></tr>';
        
        try {
            // R√©cup√©rer tous les enseignants
            const teachersSnap = await getDocs(collection(db, 'teachers'));
            
            if (teachersSnap.empty) {
                tableBody.innerHTML = '<tr><td colspan="32">Aucun enseignant trouv√©</td></tr>';
                return;
            }
            
            // R√©cup√©rer les donn√©es de pr√©sence existantes
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Formater les dates pour la requ√™te
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
            
            console.log("Recherche des pr√©sences du", startDate, "au", endDate);
            
            const attendanceQuery = query(
                collection(db, 'teacher_attendance'),
                where('date', '>=', startDate),
                where('date', '<=', endDate)
            );
            
            const attendanceSnap = await getDocs(attendanceQuery);
            teacherAttendanceData = {};
            
            attendanceSnap.forEach(doc => {
                const data = doc.data();
                if (!teacherAttendanceData[data.teacherId]) {
                    teacherAttendanceData[data.teacherId] = {};
                }
                teacherAttendanceData[data.teacherId][data.date] = data.status;
            });
            
            console.log("Pr√©sences charg√©es:", Object.keys(teacherAttendanceData).length);
            
            // Construire l'en-t√™te du tableau avec les jours du mois
            const daysInMonth = lastDay.getDate();
            let headerHTML = '<th class="teacher-name">Nom complet</th>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                headerHTML += `<th>${day}</th>`;
            }
            
            document.querySelector('#teacher-attendance-table thead tr').innerHTML = headerHTML;
            
            // Construire le corps du tableau
            tableBody.innerHTML = '';
            
            teachersSnap.forEach(doc => {
                const teacher = doc.data();
                const teacherId = teacher.uid || doc.id;
                
                let rowHTML = `<td class="teacher-name">${teacher.fullName}</td>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    const status = teacherAttendanceData[teacherId]?.[dateStr] || '';
                    
                    let statusClass = '';
                    let statusIcon = '';
                    
                    if (status === 'present') {
                        statusClass = 'present';
                        statusIcon = '‚úÖ';
                    } else if (status === 'absent') {
                        statusClass = 'absent';
                        statusIcon = 'üö´';
                    } else if (status === 'late') {
                        statusClass = 'late';
                        statusIcon = 'üü†';
                    }
                    
                    rowHTML += `
                        <td class="day-cell ${statusClass}" 
                            data-teacher="${teacherId}" 
                            data-date="${dateStr}"
                            onclick="updateTeacherAttendance('${teacherId}', '${dateStr}')">
                            ${statusIcon}
                        </td>
                    `;
                }
                
                tableBody.innerHTML += `<tr>${rowHTML}</tr>`;
            });
            
            console.log("Tableau enseignants charg√© avec", teachersSnap.size, "enseignants");
            
        } catch (error) {
            console.error('Erreur chargement tableau pr√©sence enseignants:', error);
            tableBody.innerHTML = '<tr><td colspan="32">Erreur de chargement: ' + error.message + '</td></tr>';
        }
    }

    // MISE √Ä JOUR DE LA PR√âSENCE D'UN ENSEIGNANT
    window.updateTeacherAttendance = function(teacherId, dateStr) {
        if (!teacherAttendanceData[teacherId]) {
            teacherAttendanceData[teacherId] = {};
        }
        
        teacherAttendanceData[teacherId][dateStr] = currentSelectedStatus;
        
        const cells = document.querySelectorAll(`[data-teacher="${teacherId}"][data-date="${dateStr}"]`);
        cells.forEach(cell => {
            cell.className = `day-cell ${currentSelectedStatus}`;
            
            if (currentSelectedStatus === 'present') {
                cell.innerHTML = '‚úÖ';
            } else if (currentSelectedStatus === 'absent') {
                cell.innerHTML = 'üö´';
            } else if (currentSelectedStatus === 'late') {
                cell.innerHTML = 'üü†';
            }
        });
        
        console.log(`Mise √† jour - Enseignant: ${teacherId}, Date: ${dateStr}, Statut: ${currentSelectedStatus}`);
    };

    // SAUVEGARDE DE LA PR√âSENCE DES ENSEIGNANTS
    async function saveTeacherAttendance() {
        try {
            const batch = writeBatch(db);
            let count = 0;
            
            for (const teacherId in teacherAttendanceData) {
                for (const dateStr in teacherAttendanceData[teacherId]) {
                    const status = teacherAttendanceData[teacherId][dateStr];
                    
                    if (!status) continue;
                    
                    const existingQuery = query(
                        collection(db, 'teacher_attendance'),
                        where('teacherId', '==', teacherId),
                        where('date', '==', dateStr)
                    );
                    
                    const existingSnap = await getDocs(existingQuery);
                    
                    if (!existingSnap.empty) {
                        const docId = existingSnap.docs[0].id;
                        batch.update(doc(db, 'teacher_attendance', docId), {
                            status: status,
                            updatedAt: serverTimestamp()
                        });
                    } else {
                        const newDocRef = doc(collection(db, 'teacher_attendance'));
                        batch.set(newDocRef, {
                            teacherId: teacherId,
                            date: dateStr,
                            status: status,
                            pointedBy: currentDisciplineUser.uid,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        });
                    }
                    
                    count++;
                }
            }
            
            await batch.commit();
            alert(`${count} pointages de pr√©sence enseignants sauvegard√©s avec succ√®s!`);
            console.log(`${count} pr√©sences enseignants sauvegard√©es`);
            
        } catch (error) {
            console.error('Erreur sauvegarde pr√©sence enseignants:', error);
            alert('Erreur lors de la sauvegarde des pr√©sences enseignants: ' + error.message);
        }
    }

    // PUBLICATION DE LA PR√âSENCE DES ENSEIGNANTS
    async function publishTeacherAttendance() {
        try {
            const month = parseInt(document.getElementById('teacher-month').value);
            const year = parseInt(document.getElementById('teacher-year').value);
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
            
            const attendanceQuery = query(
                collection(db, 'teacher_attendance'),
                where('date', '>=', startDate),
                where('date', '<=', endDate)
            );
            
            const attendanceSnap = await getDocs(attendanceQuery);
            const batch = writeBatch(db);
            
            attendanceSnap.forEach(doc => {
                batch.update(doc.ref, {
                    published: true,
                    publishedAt: serverTimestamp()
                });
            });
            
            await batch.commit();
            alert('Pr√©sences enseignants publi√©es avec succ√®s!');
            console.log("Pr√©sences enseignants publi√©es");
            
        } catch (error) {
            console.error('Erreur publication pr√©sence enseignants:', error);
            alert('Erreur lors de la publication des pr√©sences enseignants: ' + error.message);
        }
    }

    // CHARGEMENT DU TABLEAU DE PR√âSENCE DES √âL√àVES
    async function loadStudentAttendanceTable(classId, month, year) {
        const container = document.getElementById('student-attendance-table-container');
        const tableBody = document.getElementById('student-attendance-body');
        
        container.classList.remove('hidden');
        tableBody.innerHTML = '<tr><td colspan="32">Chargement...</td></tr>';
        
        try {
            const studentsQuery = query(collection(db, 'students'), where('class', '==', classId));
            const studentsSnap = await getDocs(studentsQuery);
            
            if (studentsSnap.empty) {
                tableBody.innerHTML = '<tr><td colspan="32">Aucun √©l√®ve trouv√© dans cette classe</td></tr>';
                return;
            }
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
            
            console.log("Recherche des pr√©sences √©l√®ves du", startDate, "au", endDate, "Classe:", classId);
            
            // R√©cup√©rer toutes les pr√©sences et filtrer manuellement
            const allAttendanceSnap = await getDocs(collection(db, 'student_attendance'));
            studentAttendanceData = {};
            
            allAttendanceSnap.forEach(doc => {
                const data = doc.data();
                if (data.date >= startDate && data.date <= endDate && data.classId === classId) {
                    if (!studentAttendanceData[data.studentId]) {
                        studentAttendanceData[data.studentId] = {};
                    }
                    studentAttendanceData[data.studentId][data.date] = data.status;
                }
            });
            
            console.log("Pr√©sences √©l√®ves charg√©es:", Object.keys(studentAttendanceData).length);
            
            const daysInMonth = lastDay.getDate();
            let headerHTML = '<th class="teacher-name">Nom complet</th>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                headerHTML += `<th>${day}</th>`;
            }
            
            document.querySelector('#student-attendance-table thead tr').innerHTML = headerHTML;
            
            tableBody.innerHTML = '';
            
            studentsSnap.forEach(doc => {
                const student = doc.data();
                const studentId = student.matricule || doc.id;
                
                let rowHTML = `<td class="teacher-name">${student.fullName}</td>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    const status = studentAttendanceData[studentId]?.[dateStr] || '';
                    
                    let statusClass = '';
                    let statusIcon = '';
                    
                    if (status === 'present') {
                        statusClass = 'present';
                        statusIcon = '‚úÖ';
                    } else if (status === 'absent') {
                        statusClass = 'absent';
                        statusIcon = 'üö´';
                    } else if (status === 'late') {
                        statusClass = 'late';
                        statusIcon = 'üü†';
                    }
                    
                    rowHTML += `
                        <td class="day-cell ${statusClass}" 
                            data-student="${studentId}" 
                            data-date="${dateStr}"
                            onclick="updateStudentAttendance('${studentId}', '${dateStr}')">
                            ${statusIcon}
                        </td>
                    `;
                }
                
                tableBody.innerHTML += `<tr>${rowHTML}</tr>`;
            });
            
            console.log("Tableau √©l√®ves charg√© avec", studentsSnap.size, "√©l√®ves");
            
        } catch (error) {
            console.error('Erreur chargement tableau pr√©sence √©l√®ves:', error);
            tableBody.innerHTML = '<tr><td colspan="32">Erreur de chargement: ' + error.message + '</td></tr>';
        }
    }

    // MISE √Ä JOUR DE LA PR√âSENCE D'UN √âL√àVE
    window.updateStudentAttendance = function(studentId, dateStr) {
        if (!studentAttendanceData[studentId]) {
            studentAttendanceData[studentId] = {};
        }
        
        studentAttendanceData[studentId][dateStr] = currentSelectedStatus;
        
        const cells = document.querySelectorAll(`[data-student="${studentId}"][data-date="${dateStr}"]`);
        cells.forEach(cell => {
            cell.className = `day-cell ${currentSelectedStatus}`;
            
            if (currentSelectedStatus === 'present') {
                cell.innerHTML = '‚úÖ';
            } else if (currentSelectedStatus === 'absent') {
                cell.innerHTML = 'üö´';
            } else if (currentSelectedStatus === 'late') {
                cell.innerHTML = 'üü†';
            }
        });
        
        console.log(`Mise √† jour - √âl√®ve: ${studentId}, Date: ${dateStr}, Statut: ${currentSelectedStatus}`);
    };

    // SAUVEGARDE DE LA PR√âSENCE DES √âL√àVES
    async function saveStudentAttendance() {
        const classId = document.getElementById('student-class').value;
        
        if (!classId) {
            alert('Veuillez s√©lectionner une classe');
            return;
        }
        
        try {
            const batch = writeBatch(db);
            let count = 0;
            
            for (const studentId in studentAttendanceData) {
                for (const dateStr in studentAttendanceData[studentId]) {
                    const status = studentAttendanceData[studentId][dateStr];
                    
                    if (!status) continue;
                    
                    // V√©rifier si une entr√©e existe d√©j√†
                    const existingQuery = query(
                        collection(db, 'student_attendance'),
                        where('studentId', '==', studentId),
                        where('date', '==', dateStr)
                    );
                    
                    const existingSnap = await getDocs(existingQuery);
                    
                    if (!existingSnap.empty) {
                        const docId = existingSnap.docs[0].id;
                        batch.update(doc(db, 'student_attendance', docId), {
                            status: status,
                            updatedAt: serverTimestamp()
                        });
                    } else {
                        const newDocRef = doc(collection(db, 'student_attendance'));
                        batch.set(newDocRef, {
                            studentId: studentId,
                            classId: classId,
                            date: dateStr,
                            status: status,
                            pointedBy: currentDisciplineUser.uid,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        });
                    }
                    
                    count++;
                }
            }
            
            await batch.commit();
            alert(`${count} pointages de pr√©sence √©l√®ves sauvegard√©s avec succ√®s!`);
            console.log(`${count} pr√©sences √©l√®ves sauvegard√©es`);
            
        } catch (error) {
            console.error('Erreur sauvegarde pr√©sence √©l√®ves:', error);
            alert('Erreur lors de la sauvegarde des pr√©sences √©l√®ves: ' + error.message);
        }
    }

    // PUBLICATION DE LA PR√âSENCE DES √âL√àVES
    async function publishStudentAttendance() {
        const classId = document.getElementById('student-class').value;
        
        if (!classId) {
            alert('Veuillez s√©lectionner une classe');
            return;
        }
        
        try {
            const month = parseInt(document.getElementById('student-month').value);
            const year = parseInt(document.getElementById('student-year').value);
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
            
            // R√©cup√©rer toutes les pr√©sences et filtrer manuellement
            const allAttendanceSnap = await getDocs(collection(db, 'student_attendance'));
            const batch = writeBatch(db);
            
            allAttendanceSnap.forEach(doc => {
                const data = doc.data();
                if (data.date >= startDate && data.date <= endDate && data.classId === classId) {
                    batch.update(doc.ref, {
                        published: true,
                        publishedAt: serverTimestamp()
                    });
                }
            });
            
            await batch.commit();
            alert('Pr√©sences √©l√®ves publi√©es avec succ√®s!');
            console.log("Pr√©sences √©l√®ves publi√©es");
            
        } catch (error) {
            console.error('Erreur publication pr√©sence √©l√®ves:', error);
            alert('Erreur lors de la publication des pr√©sences √©l√®ves: ' + error.message);
        }
    }

    // SECTION INCIDENTS - NOUVEAU MOD√àLE

    // CONFIGURATION DES ONGLETS D'INCIDENTS
    function setupIncidentTabs() {
        const tabs = document.querySelectorAll('.incident-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                // Mettre √† jour l'onglet actif
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Afficher le contenu correspondant
                document.querySelectorAll('.incident-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Configurer les boutons
        setupIncidentButtons();
    }

    // CHARGEMENT DES TYPES DE COMPORTEMENTS/INCIDENTS
    async function loadBehaviorTypes() {
        const behaviorList = document.getElementById('behavior-list');
        const incidentTypeSelect = document.getElementById('incident-type-select');
        const incidentTypeFilter = document.getElementById('incident-type-filter');
        
        try {
            const behaviorQuery = query(collection(db, 'incident_types'), orderBy('createdAt', 'asc'));
            const behaviorSnap = await getDocs(behaviorQuery);
            
            behaviorTypes = [];
            behaviorList.innerHTML = '';
            incidentTypeSelect.innerHTML = '<option value="">-- S√©lectionner un type d\'incident --</option>';
            incidentTypeFilter.innerHTML = '<option value="all">Tous les types</option>';
            
            if (behaviorSnap.empty) {
                // Ajouter des types par d√©faut
                const defaultTypes = [
                    { type: 'Bagarre', description: 'Violence physique entre √©l√®ves' },
                    { type: 'Vole', description: 'Vol de mat√©riel ou d\'argent' },
                    { type: 'Tricherie', description: 'Tricherie lors d\'un examen' },
                    { type: 'Absence non justifi√©e', description: 'Absence sans motif valable' },
                    { type: 'D√©rangement', description: 'Perturbation du cours' },
                    { type: 'Retard', description: 'Retard r√©p√©t√© aux cours' },
                    { type: 'Comportement', description: 'Comportement inappropri√©' }
                ];
                
                const batch = writeBatch(db);
                
                defaultTypes.forEach(async (behavior, index) => {
                    const newDocRef = doc(collection(db, 'incident_types'));
                    batch.set(newDocRef, {
                        type: behavior.type,
                        description: behavior.description,
                        createdAt: serverTimestamp(),
                        order: index
                    });
                    
                    behaviorTypes.push({
                        id: newDocRef.id,
                        ...behavior
                    });
                });
                
                await batch.commit();
                console.log("Types d'incidents par d√©faut ajout√©s");
            } else {
                behaviorSnap.forEach(doc => {
                    const behavior = { id: doc.id, ...doc.data() };
                    behaviorTypes.push(behavior);
                });
            }
            
            // Afficher les types dans la liste
            behaviorTypes.forEach(behavior => {
                // Pour la liste de gestion
                const behaviorItem = document.createElement('div');
                behaviorItem.className = 'behavior-item';
                behaviorItem.innerHTML = `
                    <input type="text" value="${behavior.type}" data-id="${behavior.id}" style="flex: 1;" readonly>
                    <input type="text" value="${behavior.description || ''}" data-id="${behavior.id}" style="flex: 2;" readonly>
                    <button class="btn-edit-behavior" data-id="${behavior.id}">‚úèÔ∏è</button>
                    <button class="btn-delete-behavior" data-id="${behavior.id}">üóëÔ∏è</button>
                `;
                behaviorList.appendChild(behaviorItem);
                
                // Pour le s√©lecteur de signalement
                const option = document.createElement('option');
                option.value = behavior.type;
                option.textContent = behavior.type;
                incidentTypeSelect.appendChild(option);
                
                // Pour le filtre de suivi
                const filterOption = document.createElement('option');
                filterOption.value = behavior.type;
                filterOption.textContent = behavior.type;
                incidentTypeFilter.appendChild(filterOption);
            });
            
            // Ajouter les √©v√©nements aux boutons
            setupBehaviorButtons();
            
            console.log("Types d'incidents charg√©s:", behaviorTypes.length);
            
        } catch (error) {
            console.error('Erreur chargement types d\'incidents:', error);
            behaviorList.innerHTML = '<p>Erreur de chargement des types d\'incidents.</p>';
        }
    }

    // CONFIGURATION DES BOUTONS DE GESTION DES COMPORTEMENTS
    function setupBehaviorButtons() {
        // Bouton d'ajout de comportement
        document.getElementById('add-behavior-btn').addEventListener('click', addNewBehavior);
        
        // Boutons d'√©dition/suppression
        document.querySelectorAll('.btn-edit-behavior').forEach(btn => {
            btn.addEventListener('click', function() {
                const behaviorId = this.dataset.id;
                const behavior = behaviorTypes.find(b => b.id === behaviorId);
                
                if (behavior) {
                    const typeInput = document.querySelector(`input[data-id="${behaviorId}"][style*="flex: 1;"]`);
                    const descInput = document.querySelector(`input[data-id="${behaviorId}"][style*="flex: 2;"]`);
                    
                    if (typeInput.readOnly) {
                        // Passer en mode √©dition
                        typeInput.readOnly = false;
                        descInput.readOnly = false;
                        typeInput.style.border = '1px solid var(--primary)';
                        descInput.style.border = '1px solid var(--primary)';
                        this.textContent = 'üíæ';
                    } else {
                        // Sauvegarder les modifications
                        updateBehavior(behaviorId, typeInput.value, descInput.value);
                        typeInput.readOnly = true;
                        descInput.readOnly = true;
                        typeInput.style.border = '1px solid #ddd';
                        descInput.style.border = '1px solid #ddd';
                        this.textContent = '‚úèÔ∏è';
                    }
                }
            });
        });
        
        document.querySelectorAll('.btn-delete-behavior').forEach(btn => {
            btn.addEventListener('click', function() {
                const behaviorId = this.dataset.id;
                if (confirm('√ätes-vous s√ªr de vouloir supprimer ce type d\'incident ?')) {
                    deleteBehavior(behaviorId);
                }
            });
        });
    }

    // AJOUT D'UN NOUVEAU TYPE DE COMPORTEMENT
    async function addNewBehavior() {
        const typeInput = document.getElementById('new-behavior-type');
        const descInput = document.getElementById('new-behavior-description');
        
        const type = typeInput.value.trim();
        const description = descInput.value.trim();
        
        if (!type) {
            alert('Veuillez entrer un type d\'incident');
            return;
        }
        
        try {
            const newBehavior = {
                type: type,
                description: description,
                createdAt: serverTimestamp(),
                order: behaviorTypes.length
            };
            
            const docRef = await addDoc(collection(db, 'incident_types'), newBehavior);
            newBehavior.id = docRef.id;
            behaviorTypes.push(newBehavior);
            
            // R√©initialiser les champs
            typeInput.value = '';
            descInput.value = '';
            
            // Recharger la liste
            loadBehaviorTypes();
            
            console.log('Nouveau type d\'incident ajout√©:', type);
            
        } catch (error) {
            console.error('Erreur ajout type d\'incident:', error);
            alert('Erreur lors de l\'ajout du type d\'incident: ' + error.message);
        }
    }

    // MISE √Ä JOUR D'UN TYPE DE COMPORTEMENT
    async function updateBehavior(behaviorId, type, description) {
        try {
            await updateDoc(doc(db, 'incident_types', behaviorId), {
                type: type,
                description: description,
                updatedAt: serverTimestamp()
            });
            
            console.log('Type d\'incident mis √† jour:', behaviorId);
            
        } catch (error) {
            console.error('Erreur mise √† jour type d\'incident:', error);
            alert('Erreur lors de la mise √† jour du type d\'incident: ' + error.message);
        }
    }

    // SUPPRESSION D'UN TYPE DE COMPORTEMENT
    async function deleteBehavior(behaviorId) {
        try {
            // Supprimer le document Firestore
            await deleteDoc(doc(db, 'incident_types', behaviorId));
            
            // Retirer de la liste locale
            behaviorTypes = behaviorTypes.filter(b => b.id !== behaviorId);
            
            // Recharger la liste
            await loadBehaviorTypes();
            
            console.log('Type d\'incident supprim√©:', behaviorId);
            
        } catch (error) {
            console.error('Erreur suppression type d\'incident:', error);
            alert('Erreur lors de la suppression du type d\'incident: ' + error.message);
        }
    }

    // CONFIGURATION DES BOUTONS D'INCIDENTS
    function setupIncidentButtons() {
        // Validation du matricule pour signalement
        document.getElementById('validate-matricule-btn').addEventListener('click', validateStudentForIncident);
        
        // Signalement d'incident
        document.getElementById('report-incident-btn').addEventListener('click', reportIncident);
        
        // R√©initialisation du formulaire
        document.getElementById('reset-incident-form').addEventListener('click', resetIncidentForm);
        
        // Recherche d'incidents pour suivi
        document.getElementById('search-incidents-btn').addEventListener('click', searchStudentIncidents);
        
        // Filtre par type d'incident
        document.getElementById('incident-type-filter').addEventListener('change', filterIncidentsByType);
        
        // Mise √† jour du score de discipline
        document.getElementById('update-score-btn').addEventListener('click', updateDisciplineScore);
        
        // R√©initialisation du score
        document.getElementById('reset-score-btn').addEventListener('click', resetDisciplineScore);
        
        // Slider de score
        const scoreSlider = document.getElementById('discipline-score-slider');
        const scoreDisplay = document.getElementById('score-display');
        
        scoreSlider.addEventListener('input', function() {
            scoreDisplay.textContent = this.value + '%';
        });
    }

    // VALIDATION D'UN √âL√àVE POUR SIGNALEMENT
    async function validateStudentForIncident() {
        const matricule = document.getElementById('student-matricule').value.trim();
        const studentInfo = document.getElementById('student-info-display');
        
        if (!matricule) {
            alert('Veuillez entrer un matricule');
            return;
        }
        
        try {
            const studentQuery = query(collection(db, 'students'), where('matricule', '==', matricule));
            const studentSnap = await getDocs(studentQuery);
            
            if (studentSnap.empty) {
                alert('Aucun √©l√®ve trouv√© avec ce matricule');
                return;
            }
            
            const studentDoc = studentSnap.docs[0];
            const studentData = studentDoc.data();
            
            selectedStudentForIncident = {
                id: studentDoc.id,
                matricule: studentData.matricule,
                fullName: studentData.fullName,
                class: studentData.class
            };
            
            // Afficher les informations de l'√©l√®ve
            document.getElementById('student-display-name').textContent = studentData.fullName;
            document.getElementById('student-display-matricule').textContent = studentData.matricule;
            document.getElementById('student-display-class').textContent = studentData.class;
            
            studentInfo.classList.remove('hidden');
            
            console.log('√âl√®ve valid√© pour incident:', selectedStudentForIncident);
            
        } catch (error) {
            console.error('Erreur validation √©l√®ve:', error);
            alert('Erreur lors de la validation du matricule: ' + error.message);
        }
    }

    // SIGNALEMENT D'UN INCIDENT
    async function reportIncident() {
        if (!selectedStudentForIncident) {
            alert('Veuillez d\'abord valider le matricule d\'un √©l√®ve');
            return;
        }
        
        const incidentType = document.getElementById('incident-type-select').value;
        const description = document.getElementById('incident-description').value.trim();
        
        if (!incidentType) {
            alert('Veuillez s√©lectionner un type d\'incident');
            return;
        }
        
        if (!description) {
            alert('Veuillez d√©crire l\'incident');
            return;
        }
        
        try {
            // R√©cup√©rer le score actuel de l'√©l√®ve
            const scoreQuery = query(collection(db, 'discipline_scores'), where('studentId', '==', selectedStudentForIncident.id));
            const scoreSnap = await getDocs(scoreQuery);
            
            let currentScore = 0;
            let scoreDocId = null;
            
            if (!scoreSnap.empty) {
                const scoreData = scoreSnap.docs[0].data();
                currentScore = scoreData.score || 0;
                scoreDocId = scoreSnap.docs[0].id;
            }
            
            // Calculer l'augmentation du score bas√©e sur le type d'incident
            const scoreIncrease = calculateScoreIncrease(incidentType);
            const newScore = Math.min(100, currentScore + scoreIncrease);
            
            // Enregistrer l'incident
            const incidentData = {
                studentId: selectedStudentForIncident.id,
                studentName: selectedStudentForIncident.fullName,
                studentMatricule: selectedStudentForIncident.matricule,
                studentClass: selectedStudentForIncident.class,
                type: incidentType,
                description: description,
                scoreIncrease: scoreIncrease,
                previousScore: currentScore,
                newScore: newScore,
                reportedBy: currentDisciplineUser.uid,
                reportedByName: currentDisciplineUser.fullName,
                createdAt: serverTimestamp()
            };
            
            const incidentRef = await addDoc(collection(db, 'incidents'), incidentData);
            console.log('Incident signal√©:', incidentRef.id);
            
            // Mettre √† jour le score de discipline
            if (scoreDocId) {
                await updateDoc(doc(db, 'discipline_scores', scoreDocId), {
                    score: newScore,
                    updatedAt: serverTimestamp(),
                    lastIncidentId: incidentRef.id,
                    lastIncidentType: incidentType
                });
            } else {
                await setDoc(doc(collection(db, 'discipline_scores')), {
                    studentId: selectedStudentForIncident.id,
                    studentName: selectedStudentForIncident.fullName,
                    studentMatricule: selectedStudentForIncident.matricule,
                    studentClass: selectedStudentForIncident.class,
                    score: newScore,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    lastIncidentId: incidentRef.id,
                    lastIncidentType: incidentType
                });
            }
            
            alert(`Incident signal√© avec succ√®s !\nScore de discipline: ${currentScore}% ‚Üí ${newScore}%`);
            
            // R√©initialiser le formulaire
            resetIncidentForm();
            
            // Si on est sur l'onglet de suivi et qu'on suit d√©j√† cet √©l√®ve, recharger les donn√©es
            if (currentTrackedStudent && currentTrackedStudent.id === selectedStudentForIncident.id) {
                loadStudentIncidents(selectedStudentForIncident.id);
            }
            
        } catch (error) {
            console.error('Erreur signalement incident:', error);
            alert('Erreur lors du signalement de l\'incident: ' + error.message);
        }
    }

    // CALCUL DE L'AUGMENTATION DU SCORE
    function calculateScoreIncrease(incidentType) {
        // Logique d'augmentation du score bas√©e sur la gravit√© du type d'incident
        const scoreMap = {
            'Bagarre': 20,
            'Vole': 15,
            'Tricherie': 10,
            'Absence non justifi√©e': 5,
            'D√©rangement': 3,
            'Retard': 2,
            'Comportement': 5,
            'Autre': 5
        };
        
        return scoreMap[incidentType] || 5;
    }

    // R√âINITIALISATION DU FORMULAIRE D'INCIDENT
    function resetIncidentForm() {
        document.getElementById('student-matricule').value = '';
        document.getElementById('student-info-display').classList.add('hidden');
        document.getElementById('incident-type-select').value = '';
        document.getElementById('incident-description').value = '';
        selectedStudentForIncident = null;
    }

    // RECHERCHE DES INCIDENTS D'UN √âL√àVE POUR SUIVI
    async function searchStudentIncidents() {
        const matricule = document.getElementById('tracking-matricule').value.trim();
        const resultsDiv = document.getElementById('tracking-results');
        
        if (!matricule) {
            alert('Veuillez entrer un matricule');
            return;
        }
        
        try {
            const studentQuery = query(collection(db, 'students'), where('matricule', '==', matricule));
            const studentSnap = await getDocs(studentQuery);
            
            if (studentSnap.empty) {
                alert('Aucun √©l√®ve trouv√© avec ce matricule');
                return;
            }
            
            const studentDoc = studentSnap.docs[0];
            const studentData = studentDoc.data();
            
            currentTrackedStudent = {
                id: studentDoc.id,
                matricule: studentData.matricule,
                fullName: studentData.fullName,
                class: studentData.class
            };
            
            // Afficher les informations de l'√©l√®ve
            document.getElementById('tracking-student-name').textContent = studentData.fullName;
            document.getElementById('tracking-student-matricule').textContent = studentData.matricule;
            document.getElementById('tracking-student-class').textContent = studentData.class;
            
            // Charger les incidents et le score
            loadStudentIncidents(studentDoc.id);
            
            resultsDiv.classList.remove('hidden');
            
            console.log('Incidents charg√©s pour:', currentTrackedStudent);
            
        } catch (error) {
            console.error('Erreur recherche incidents:', error);
            alert('Erreur lors de la recherche d\'incidents: ' + error.message);
        }
    }

    // CHARGEMENT DES INCIDENTS D'UN √âL√àVE
    async function loadStudentIncidents(studentId) {
        try {
            // R√©cup√©rer le score de discipline
            const scoreQuery = query(collection(db, 'discipline_scores'), where('studentId', '==', studentId));
            const scoreSnap = await getDocs(scoreQuery);
            
            let currentScore = 0;
            
            if (!scoreSnap.empty) {
                const scoreData = scoreSnap.docs[0].data();
                currentScore = scoreData.score || 0;
            }
            
            // Afficher le score
            document.getElementById('tracking-score').textContent = currentScore + '%';
            
            // Mettre √† jour la barre de progression
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = currentScore + '%';
            
            // Mettre √† jour le slider
            const scoreSlider = document.getElementById('discipline-score-slider');
            const scoreDisplay = document.getElementById('score-display');
            scoreSlider.value = currentScore;
            scoreDisplay.textContent = currentScore + '%';
            
            // Charger les incidents
            const incidentsQuery = query(
                collection(db, 'incidents'),
                where('studentId', '==', studentId),
                orderBy('createdAt', 'desc')
            );
            
            const incidentsSnap = await getDocs(incidentsQuery);
            const historyDiv = document.getElementById('incident-history');
            
            if (incidentsSnap.empty) {
                historyDiv.innerHTML = '<p>Aucun incident signal√© pour cet √©l√®ve.</p>';
                return;
            }
            
            historyDiv.innerHTML = '';
            incidentsSnap.forEach(doc => {
                const incident = doc.data();
                const date = incident.createdAt ? new Date(incident.createdAt.toDate()).toLocaleDateString('fr-FR') : 'Date inconnue';
                
                const incidentItem = document.createElement('div');
                incidentItem.className = 'history-item';
                incidentItem.innerHTML = `
                    <div style="margin-bottom: 0.5rem;">
                        <strong>${incident.type}</strong>
                        <span style="float: right; color: #666;">${date}</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #555;">
                        ${incident.description}
                    </div>
                    <div style="font-size: 0.8rem; color: #777; margin-top: 0.5rem;">
                        Signal√© par: ${incident.reportedByName || 'Non sp√©cifi√©'}
                        <span style="float: right;">
                            Score: ${incident.previousScore || 0}% ‚Üí ${incident.newScore || 0}%
                            (+${incident.scoreIncrease || 0}%)
                        </span>
                    </div>
                `;
                
                historyDiv.appendChild(incidentItem);
            });
            
            console.log('Incidents charg√©s:', incidentsSnap.size);
            
        } catch (error) {
            console.error('Erreur chargement incidents √©l√®ve:', error);
            document.getElementById('incident-history').innerHTML = '<p>Erreur de chargement des incidents.</p>';
        }
    }

    // FILTRAGE DES INCIDENTS PAR TYPE
    function filterIncidentsByType() {
        const selectedType = document.getElementById('incident-type-filter').value;
        const historyItems = document.querySelectorAll('#incident-history .history-item');
        
        historyItems.forEach(item => {
            const incidentType = item.querySelector('strong').textContent;
            
            if (selectedType === 'all' || incidentType === selectedType) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // MISE √Ä JOUR MANUELLE DU SCORE DE DISCIPLINE
    async function updateDisciplineScore() {
        if (!currentTrackedStudent) {
            alert('Veuillez d\'abord rechercher un √©l√®ve');
            return;
        }
        
        const newScore = parseInt(document.getElementById('discipline-score-slider').value);
        const comment = document.getElementById('score-comment').value.trim();
        
        try {
            // R√©cup√©rer le document de score existant
            const scoreQuery = query(collection(db, 'discipline_scores'), where('studentId', '==', currentTrackedStudent.id));
            const scoreSnap = await getDocs(scoreQuery);
            
            const updateData = {
                score: newScore,
                updatedAt: serverTimestamp(),
                lastManualUpdate: serverTimestamp(),
                lastManualUpdateBy: currentDisciplineUser.uid,
                lastManualUpdateByName: currentDisciplineUser.fullName,
                lastManualUpdateComment: comment
            };
            
            if (!scoreSnap.empty) {
                // Mettre √† jour le score existant
                await updateDoc(doc(db, 'discipline_scores', scoreSnap.docs[0].id), updateData);
            } else {
                // Cr√©er un nouveau document de score
                updateData.studentId = currentTrackedStudent.id;
                updateData.studentName = currentTrackedStudent.fullName;
                updateData.studentMatricule = currentTrackedStudent.matricule;
                updateData.studentClass = currentTrackedStudent.class;
                updateData.createdAt = serverTimestamp();
                
                await setDoc(doc(collection(db, 'discipline_scores')), updateData);
            }
            
            // Enregistrer un incident sp√©cial pour la mise √† jour manuelle
            const manualIncident = {
                studentId: currentTrackedStudent.id,
                studentName: currentTrackedStudent.fullName,
                studentMatricule: currentTrackedStudent.matricule,
                studentClass: currentTrackedStudent.class,
                type: 'Mise √† jour manuelle',
                description: comment || 'Mise √† jour manuelle du score de discipline',
                scoreIncrease: newScore - parseInt(document.getElementById('tracking-score').textContent.replace('%', '')),
                previousScore: parseInt(document.getElementById('tracking-score').textContent.replace('%', '')),
                newScore: newScore,
                reportedBy: currentDisciplineUser.uid,
                reportedByName: currentDisciplineUser.fullName,
                createdAt: serverTimestamp()
            };
            
            await addDoc(collection(db, 'incidents'), manualIncident);
            
            // Recharger les donn√©es
            loadStudentIncidents(currentTrackedStudent.id);
            
            alert(`Score de discipline mis √† jour √† ${newScore}%`);
            
            // R√©initialiser le commentaire
            document.getElementById('score-comment').value = '';
            
        } catch (error) {
            console.error('Erreur mise √† jour score:', error);
            alert('Erreur lors de la mise √† jour du score: ' + error.message);
        }
    }

    // R√âINITIALISATION DU SCORE DE DISCIPLINE
    async function resetDisciplineScore() {
        if (!currentTrackedStudent) {
            alert('Veuillez d\'abord rechercher un √©l√®ve');
            return;
        }
        
        if (!confirm('√ätes-vous s√ªr de vouloir r√©initialiser le score de discipline de cet √©l√®ve √† 0% ?')) {
            return;
        }
        
        try {
            // R√©cup√©rer le document de score existant
            const scoreQuery = query(collection(db, 'discipline_scores'), where('studentId', '==', currentTrackedStudent.id));
            const scoreSnap = await getDocs(scoreQuery);
            
            if (!scoreSnap.empty) {
                // Mettre √† jour le score √† 0
                await updateDoc(doc(db, 'discipline_scores', scoreSnap.docs[0].id), {
                    score: 0,
                    updatedAt: serverTimestamp(),
                    lastReset: serverTimestamp(),
                    lastResetBy: currentDisciplineUser.uid,
                    lastResetByName: currentDisciplineUser.fullName
                });
            } else {
                // Cr√©er un nouveau document avec score 0
                await setDoc(doc(collection(db, 'discipline_scores')), {
                    studentId: currentTrackedStudent.id,
                    studentName: currentTrackedStudent.fullName,
                    studentMatricule: currentTrackedStudent.matricule,
                    studentClass: currentTrackedStudent.class,
                    score: 0,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    lastReset: serverTimestamp(),
                    lastResetBy: currentDisciplineUser.uid,
                    lastResetByName: currentDisciplineUser.fullName
                });
            }
            
            // Enregistrer un incident sp√©cial pour la r√©initialisation
            const resetIncident = {
                studentId: currentTrackedStudent.id,
                studentName: currentTrackedStudent.fullName,
                studentMatricule: currentTrackedStudent.matricule,
                studentClass: currentTrackedStudent.class,
                type: 'R√©initialisation',
                description: 'R√©initialisation manuelle du score de discipline √† 0%',
                scoreIncrease: -parseInt(document.getElementById('tracking-score').textContent.replace('%', '')),
                previousScore: parseInt(document.getElementById('tracking-score').textContent.replace('%', '')),
                newScore: 0,
                reportedBy: currentDisciplineUser.uid,
                reportedByName: currentDisciplineUser.fullName,
                createdAt: serverTimestamp()
            };
            
            await addDoc(collection(db, 'incidents'), resetIncident);
            
            // Recharger les donn√©es
            loadStudentIncidents(currentTrackedStudent.id);
            
            alert('Score de discipline r√©initialis√© √† 0%');
            
        } catch (error) {
            console.error('Erreur r√©initialisation score:', error);
            alert('Erreur lors de la r√©initialisation du score: ' + error.message);
        }
    }

    // NAVIGATION
    document.querySelectorAll('.nav-menu a').forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const pageId = link.dataset.page + '-page';
            
            if (window.innerWidth <= 767) {
                document.querySelector('.sidebar').classList.remove('active');
                document.getElementById('sidebar-overlay').classList.remove('active');
            }
            
            document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
            link.classList.add('active');
            document.getElementById(pageId).classList.add('active');
            document.getElementById('page-title').textContent = link.textContent;
        });
    });
    </script>

    <script>
    // Initialisation imm√©diate
    (function() {
        // V√©rifier si Service Worker est support√©
        if ('serviceWorker' in navigator) {
            // Enregistrer le Service Worker imm√©diatement
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('‚úÖ Service Worker enregistr√© avec succ√®s');
                    
                    // V√©rifier les mises √† jour toutes les 15 minutes
                    setInterval(() => {
                        registration.update();
                    }, 15 * 60 * 1000);
                    
                    // V√©rifier maintenant
                    setTimeout(() => {
                        registration.update();
                    }, 10000);
                    
                } catch (error) {
                    console.error('‚ùå Erreur Service Worker:', error);
                }
            });
        }
        
        // Afficher la version dans la console
        console.log('%cüöÄ CS La Colombe - Espace Parent', 'color: #3498db; font-size: 16px; font-weight: bold;');
        console.log('%cSyst√®me de mise √† jour en temps r√©el activ√©', 'color: #2ecc71;');
        
    })();

    // Fonctions utilitaires
    window.reloadApp = function() {
        window.location.reload();
    };

    window.clearAppCache = function() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => {
                    registration.unregister();
                });
            });
        }
        
        caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => {
                caches.delete(cacheName);
            });
        });
        
        localStorage.clear();
        sessionStorage.clear();
        
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    };
    </script>

    <script>
    // Afficher une notification de mise √† jour
    function showUpdateNotification(newVersion, previousVersion) {
        const updateToast = document.createElement('div');
        updateToast.className = 'notification-toast success';
        updateToast.innerHTML = `
            <div class="notification-header">
                <div class="notification-title">
                    <i class="fas fa-sync-alt"></i> Mise √† jour disponible
                </div>
                <button class="notification-close">&times;</button>
            </div>
            <div class="notification-body">
                <p>Une nouvelle version (${newVersion}) de l'application est disponible !</p>
                <p><small>Version pr√©c√©dente: ${previousVersion || 'inconnue'}</small></p>
                <div class="notification-actions" style="margin-top: 10px;">
                    <button class="btn btn-primary btn-sm" id="update-app-btn">
                        <i class="fas fa-redo"></i> Mettre √† jour
                    </button>
                    <button class="btn btn-secondary btn-sm" id="later-update-btn">
                        Plus tard
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(updateToast);
        
        setTimeout(() => {
            updateToast.classList.add('show');
        }, 1000);
        
        // G√©rer le bouton de mise √† jour
        document.getElementById('update-app-btn').addEventListener('click', () => {
            updateToast.classList.remove('show');
            setTimeout(() => updateToast.remove(), 300);
            
            // Recharger la page pour activer la nouvelle version
            window.location.reload();
        });
        
        // G√©rer le bouton "Plus tard"
        document.getElementById('later-update-btn').addEventListener('click', () => {
            updateToast.classList.remove('show');
            setTimeout(() => updateToast.remove(), 300);
        });
        
        // Fermer le toast
        updateToast.querySelector('.notification-close').addEventListener('click', () => {
            updateToast.classList.remove('show');
            setTimeout(() => updateToast.remove(), 300);
        });
    }

    // Afficher une notification de mise √† jour obligatoire
    function showMandatoryUpdateNotification(newVersion, currentVersion, updateUrl) {
        const mandatoryToast = document.createElement('div');
        mandatoryToast.className = 'notification-toast danger';
        mandatoryToast.style.zIndex = '99999'; // Assurez-vous qu'il est au-dessus de tout
        mandatoryToast.innerHTML = `
            <div class="notification-header">
                <div class="notification-title">
                    <i class="fas fa-exclamation-triangle"></i> Mise √† jour REQUISE
                </div>
                <button class="notification-close" disabled>&times;</button>
            </div>
            <div class="notification-body">
                <p><strong>Mise √† jour obligatoire !</strong></p>
                <p>La version ${newVersion} est requise pour continuer √† utiliser l'application.</p>
                <p><small>Votre version actuelle: ${currentVersion}</small></p>
                <div class="notification-actions" style="margin-top: 10px;">
                    <button class="btn btn-warning btn-sm" id="mandatory-update-btn">
                        <i class="fas fa-download"></i> Mettre √† jour maintenant
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(mandatoryToast);
        
        setTimeout(() => {
            mandatoryToast.classList.add('show');
            
            // Bloquer l'interface utilisateur
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
            overlay.style.zIndex = '99998';
            overlay.id = 'update-overlay';
            document.body.appendChild(overlay);
        }, 500);
        
        // G√©rer le bouton de mise √† jour obligatoire
        document.getElementById('mandatory-update-btn').addEventListener('click', () => {
            // Rediriger vers l'URL de mise √† jour
            window.location.href = updateUrl;
        });
        
        // Emp√™cher la fermeture
        mandatoryToast.querySelector('.notification-close').addEventListener('click', (e) => {
            e.preventDefault();
            alert('Cette mise √† jour est obligatoire pour continuer √† utiliser l\'application');
        });
    }

    // V√©rifier les mises √† jour manuellement
    async function checkForUpdates() {
        try {
            const response = await fetch(`/version-check.json?t=${Date.now()}`);
            const data = await response.json();
            
            // V√©rifier la version actuelle depuis le service worker
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'GET_VERSION'
                });
            }
            
            // Comparer avec la version stock√©e localement
            const currentVersion = localStorage.getItem('app_version');
            
            if (currentVersion !== data.version) {
                // Nouvelle version disponible
                showUpdateNotification(data.version, currentVersion);
                localStorage.setItem('app_version', data.version);
                
                // Si la mise √† jour est obligatoire
                if (data.mandatory === true) {
                    showMandatoryUpdateNotification(data.version, currentVersion, data.updateUrl);
                }
            }
            
        } catch (error) {
            console.error('Erreur lors de la v√©rification des mises √† jour:', error);
        }
    }

    // V√©rifier la version au chargement
    window.addEventListener('load', () => {
        // Stocker la version actuelle
        if (!localStorage.getItem('app_version')) {
            localStorage.setItem('app_version', '1.0.0');
        }
        
        // V√©rifier les mises √† jour apr√®s 5 secondes
        setTimeout(() => {
            checkForUpdates();
        }, 5000);
    });

    // √âcouter les √©v√©nements de mise √† jour du service worker
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
            refreshing = true;
            window.location.reload();
        }
    });
    </script>
<script>
// windows-mac-install.js
if (navigator.userAgent.includes('Windows') || navigator.userAgent.includes('Macintosh')) {
    // Afficher un message sp√©cial pour les ordinateurs
    setTimeout(() => {
        if (!window.matchMedia('(display-mode: standalone)').matches) {
            const desktopPrompt = document.createElement('div');
            desktopPrompt.id = 'desktop-install-prompt';
            desktopPrompt.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                z-index: 99999;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
                border-left: 5px solid #3498db;
            `;
            
            desktopPrompt.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <i class="fas fa-desktop" style="font-size: 24px; color: #3498db;"></i>
                    <div>
                        <h4 style="margin: 0; color: #2c3e50;">Installer l'application</h4>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Pour un acc√®s rapide</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="install-desktop-btn" 
                            style="flex: 1; background: #3498db; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                        Installer
                    </button>
                    <button id="close-desktop-prompt" 
                            style="background: transparent; color: #666; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer;">
                        √ó
                    </button>
                </div>
            `;
            
            document.body.appendChild(desktopPrompt);
            
            document.getElementById('install-desktop-btn').addEventListener('click', () => {
                if (window.installPrompt) {
                    window.installPrompt.handleInstall();
                }
                desktopPrompt.remove();
            });
            
            document.getElementById('close-desktop-prompt').addEventListener('click', () => {
                desktopPrompt.remove();
                localStorage.setItem('desktop_prompt_closed', 'true');
            });
        }
    }, 5000);
}


    

        
    </script>




</body>
</html>
